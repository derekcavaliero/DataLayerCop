/**!
 * DataLayerCop.js
 * 
 * A utility library to help enforce dataLayer conventions and syntax.
 * Because sometimes... you just need to be the bad ðŸ‘®.
 *
 * Author: Derek Cavaliero (@derekcavaliero)
 * Repository: https://github.com/derekcavaliero/datalayercop
 * Version: 1.0.beta
 * License: MIT
 */
class DataLayerCop{#e={};constructor(e={}){this.#e=this.#t({dataLayer:"dataLayer",preferredCase:"snake",report:{toUrl:!1,toDataLayer:!1},rules:[]},e),this.#r(),this.#a(),Array.isArray(this.#e.rules)&&this.#e.rules?.length?(this.#s(),this.#o().push({event:"datalayercop.loaded",rules:this.#e.rules})):this.#n("warn","No rules defined.")}#t(e,t){for(const r of Object.keys(t))t[r]instanceof Object&&Object.assign(t[r],this.#t(e[r],t[r]));return Object.assign(e||{},t),e}#r(){window[this.#e.dataLayer]=window[this.#e.dataLayer]||[]}#o(){return window[this.#e.dataLayer]}#s(){var e=this,t=this.#o().push;this.#o().push=function(){let r;if(e.#i(arguments[0])){let t=arguments[0];"event"==t[0]&&(r=e.#c(t,"gtag"))}else e.#p("isObjectLiteral",arguments[0])&&(r=arguments[0],r?.event?.startsWith("gtm.")||(r=e.#c(r,"gtm")));if(r)return t(r)}}#a(){this.#e.rules=this.#e.rules.map((e=>(e.predefined&&delete(e=Object.assign({},this.#l(e.predefined),e)).predefined,e)))}#l(e){return{event_property_exists:{name:"Expect payload to include an `event` property.",assert:e=>e.hasOwnProperty("event")&&e.event.length,dropOnFail:!1,type:"gtm"},event_is_namespaced:{name:"Expect `event` property value to be prefixed with a namespace.",assert:e=>this.#p("isNamespaced",e.event),dropOnFail:!1,type:"gtm"},payload_properties_are_preferred_case:{name:`Expect all payload properties to match preferred case (${this.#e.preferredCase}).`,assert:e=>{const t=Object.keys(e);for(let e=0;e<t.length;e++)if(!this.#d(t[e]))return!1;return!0},dropOnFail:!1},event_is_preferred_case_after_namespace:{name:`Expect \`event\` property value to match preferred case (${this.#e.preferredCase}) after namespace.`,assert:e=>{if(!this.#p("isNamespaced",e.event))return!0;const t=e.event.split(".")[1];return this.#d(t)},dropOnFail:!1,type:"gtm"}}[e]||{}}#u(e={},t,r){let a={rule:e,payload:t,payloadType:r};return"function"!=typeof e.assert?(this.#n("warn","Rule object is missing assert method - skipping...",e),a.passed=!0,a):(a.passed=e.assert(t,r),a.passed||this.#n("warn",`${r} payload failed rule: ${e?.name}`,a),a)}#c(e,t){for(let r=0;r<this.#e.rules.length;r++){let a=this.#e.rules[r];if(a?.type&&a.type!==t)continue;let s=this.#u(a,e,t);if(!s.passed&&(this.#e.report.only.includes(a?.severity)&&(this.#g(s),this.#e.report.toUrl&&this.#h(s)),a.dropOnFail))return!1}return e}#n(e,t,r){console[e](`ðŸš¨ ${this.#e.dataLayer} Cop - ${t}`,r)}#g(e){!1!==this.#e.report.toDataLayer&&this.#o().push({event:"gtm.pageError","gtm.errorMessage":e.rule?.name,datalayercop:e})}#h(e){if(!this.#f(this.#e.report.toUrl))return void this.#n("warn",`Attempted to report to URL - but an invalid URL was provided (${this.#e.report.toUrl}).`,payload);let t={hostname:location.hostname,url:location.href,user_agent:navigator.userAgent};Object.assign(t,e),t.payload=this.#y(t.payload),navigator.sendBeacon(this.#e.report.toUrl,JSON.stringify(t))}#y(e,t){let r=JSON.parse(JSON.stringify(e));const a=Object.keys(r);for(let e=0;e<a.length;e++){let t=a[e],s=r[t];if("object"==typeof s){r[t]=this.#y(s);continue}new RegExp("name|email|tele|phone|address|street|country|city|state|province|region|zip|postal|country|birth|dob|born|gender|sex|race|ethnicity|height|weight|password","i").test(t)&&(r[t]="(redacted)")}return r}#i(e){return"[object Arguments]"===Object.prototype.toString.call(e)}#f(e){try{var t=new URL(e)}catch(e){return!1}return"https:"===t.protocol}#d(e){return DataLayerCop.getCommonPattern(this.#e.preferredCase).test(e)}#p(e,...t){return DataLayerCop[e].apply(this,t)}static getCommonPattern(e){switch(e){case"snake":return/^[a-z0-9_]+$/;case"camel":return/^[a-z0-9]+([A-Z][a-z0-9]+)*$/;case"pascal":return/^[A-Z][a-z0-9]+([A-Z][a-z0-9]+)*$/;case"namespaced":return/^([a-zA-Z0-9_]+\.)/;default:return e}}static isObjectLiteral(e){var t=e;return"object"==typeof e&&null!==e&&function(){for(;null!==Object.getPrototypeOf(t=Object.getPrototypeOf(t)););return Object.getPrototypeOf(e)===t}()}static isSnakeCase(e){return DataLayerCop.getCommonPattern("snake").test(e)}static isCamelCase(e){return DataLayerCop.getCommonPattern("camel").test(e)}static isPascalCase(e){return DataLayerCop.getCommonPattern("pascal").test(e)}static isNamespaced(e){return DataLayerCop.getCommonPattern("namespaced").test(e)}}
