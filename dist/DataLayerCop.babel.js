/**!
 * DataLayerCop.js
 * 
 * A utility library to help enforce dataLayer conventions and syntax.
 * Because sometimes... you just need to be the bad ðŸ‘®.
 *
 * Author: Derek Cavaliero (@derekcavaliero)
 * Repository: https://github.com/derekcavaliero/datalayercop
 * Version: 1.0.beta
 * License: MIT
 */
"use strict";function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var DataLayerCop=function(){function e(){var t,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,e);this.config={},Object.assign(this.config,{dataLayer:"dataLayer",preferredCase:"snake",report:{toUrl:!1,toDataLayer:!1},rules:[]},r),this.setDataLayer(),this.registerRules(),Array.isArray(this.config.rules)&&null!==(t=this.config.rules)&&void 0!==t&&t.length?(this.modifyPushMethod(),this.getDataLayer().push({event:"datalayercop.loaded",rules:this.config.rules})):this.console("warn","No rules defined.")}return _createClass(e,[{key:"setDataLayer",value:function(){window[this.config.dataLayer]=window[this.config.dataLayer]||[]}},{key:"getDataLayer",value:function(){return window[this.config.dataLayer]}},{key:"getPredefinedRule",value:function(e){var t=this;return{event_property_is_defined:{name:"Expect payload to include an `event` property.",assert:function(e){return void 0!==e.event},dropOnFail:!1,type:"gtm"},event_is_namespaced:{name:"Expect `event` property value to be prefixed with a namespace.",assert:function(e){return t.callStatic("isNamespaced",e.event)},dropOnFail:!1,type:"gtm"},payload_properties_are_preferred_case:{name:"Expect all payload properties to match preferred case (".concat(this.config.preferredCase,")."),assert:function(e){for(var r=Object.keys(e),n=0;n<r.length;n++)if(!t.isPreferredCase(r[n]))return!1;return!0},dropOnFail:!1},event_is_preferred_case_after_namespace:{name:"Expect `event` property value to match preferred case (".concat(this.config.preferredCase,") after namespace."),assert:function(e){if(!t.callStatic("isNamespaced",e.event))return!0;var r=e.event.split(".")[1];return t.isPreferredCase(r)},dropOnFail:!1,type:"gtm"}}[e]||{}}},{key:"registerRules",value:function(){var e=this;this.config.rules=this.config.rules.map((function(t){return t.predefined&&delete(t=Object.assign({},e.getPredefinedRule(t.predefined),t)).predefined,t}))}},{key:"processRules",value:function(e,t){for(var r=0;r<this.config.rules.length;r++){var n=this.config.rules[r];if(null==n||!n.type||n.type===t){var a=this.enforce(n,e,t);if(!a.passed&&(this.config.report.only.includes(null==n?void 0:n.severity)&&(this.reportToUrl(a),this.reportToDataLayer(a)),n.dropOnFail))return!1}}return e}},{key:"reportToDataLayer",value:function(e){var t;!1!==this.config.report.toDataLayer&&(e.payload=JSON.stringify(e.payload),this.getDataLayer().push({event:"gtm.pageError","gtm.errorMessage":null===(t=e.rule)||void 0===t?void 0:t.name,datalayercop:e}))}},{key:"reportToUrl",value:function(e){if(this.isValidUrl(this.config.report.toUrl)){var t={hostname:location.hostname,url:location.href,user_agent:navigator.userAgent};Object.assign(t,e),navigator.sendBeacon(this.config.report.toUrl,JSON.stringify(t))}else this.console("warn","Attempted to report to URL - but an invalid URL was provided (".concat(this.config.report.toUrl,")."))}},{key:"modifyPushMethod",value:function(){var e=this,t=this.getDataLayer().push;this.getDataLayer().push=function(){var r;if(e.isArgumentsObject(arguments[0])){var n=arguments[0];"event"==n[0]&&(r=e.processRules(n,"gtag"))}else if(e.callStatic("isObjectLiteral",arguments[0])){var a;null!==(a=r=arguments[0])&&void 0!==a&&null!==(a=a.event)&&void 0!==a&&a.startsWith("gtm.")||(r=e.processRules(r,"gtm"))}if(r)return t(r)}}},{key:"enforce",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,n={rule:e,payload:t,payloadType:r};return"function"!=typeof e.assert?(this.console("warn","Rule object is missing assert method - skipping...",e),n.passed=!0,n):(n.passed=e.assert(t,r),n.passed||this.console("warn","".concat(r," payload failed rule: ").concat(null==e?void 0:e.name),n),n)}},{key:"callStatic",value:function(t){for(var r=arguments.length,n=new Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];return e[t].apply(this,n)}},{key:"console",value:function(e){function t(t,r,n){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e,t,r){console[e]("ðŸš¨ ".concat(this.config.dataLayer," Cop - ").concat(t),r)}))},{key:"isArgumentsObject",value:function(e){return"[object Arguments]"===Object.prototype.toString.call(e)}},{key:"isValidUrl",value:function(e){try{var t=new URL(e)}catch(e){return!1}return"https:"===t.protocol}},{key:"isPreferredCase",value:function(t){return e.getCommonPattern(this.config.preferredCase).test(t)}}],[{key:"getCommonPattern",value:function(e){switch(e){case"snake":return/^[a-z0-9_]+$/;case"camel":return/^[a-z0-9]+([A-Z][a-z0-9]+)*$/;case"pascal":return/^[A-Z][a-z0-9]+([A-Z][a-z0-9]+)*$/;case"namespaced":return/^([a-zA-Z0-9_]+\.)/;default:return e}}},{key:"isObjectLiteral",value:function(e){var t=e;return"object"===_typeof(e)&&null!==e&&function(){for(;null!==Object.getPrototypeOf(t=Object.getPrototypeOf(t)););return Object.getPrototypeOf(e)===t}()}},{key:"isSnakeCase",value:function(t){return e.getCommonPattern("snake").test(t)}},{key:"isCamelCase",value:function(t){return e.getCommonPattern("camel").test(t)}},{key:"isPascalCase",value:function(t){return e.getCommonPattern("pascal").test(t)}},{key:"isNamespaced",value:function(t){return e.getCommonPattern("namespaced").test(t)}}]),e}();
